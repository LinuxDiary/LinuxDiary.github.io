<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>KVM | 个人文档库</title>
    <meta name="generator" content="VuePress 1.9.8">
    
    <meta name="description" content="运维知识文档">
    
    <link rel="preload" href="/assets/css/0.styles.86682925.css" as="style"><link rel="preload" href="/assets/js/app.6ea617b8.js" as="script"><link rel="preload" href="/assets/js/2.6e381248.js" as="script"><link rel="preload" href="/assets/js/17.7976f036.js" as="script"><link rel="prefetch" href="/assets/js/10.dd27a2bb.js"><link rel="prefetch" href="/assets/js/11.ec440828.js"><link rel="prefetch" href="/assets/js/12.c67fbef0.js"><link rel="prefetch" href="/assets/js/13.a53b31f6.js"><link rel="prefetch" href="/assets/js/14.fac02fcf.js"><link rel="prefetch" href="/assets/js/15.366e462e.js"><link rel="prefetch" href="/assets/js/16.ae609dff.js"><link rel="prefetch" href="/assets/js/18.3f258419.js"><link rel="prefetch" href="/assets/js/19.0ad2626e.js"><link rel="prefetch" href="/assets/js/20.bdf3dbe2.js"><link rel="prefetch" href="/assets/js/21.04180477.js"><link rel="prefetch" href="/assets/js/22.f4cf519a.js"><link rel="prefetch" href="/assets/js/23.9e5b52cd.js"><link rel="prefetch" href="/assets/js/24.b0159ef8.js"><link rel="prefetch" href="/assets/js/25.e38d986a.js"><link rel="prefetch" href="/assets/js/26.b44e8359.js"><link rel="prefetch" href="/assets/js/27.164897ca.js"><link rel="prefetch" href="/assets/js/28.30c3dcb6.js"><link rel="prefetch" href="/assets/js/29.0ea1763d.js"><link rel="prefetch" href="/assets/js/3.87c14ff3.js"><link rel="prefetch" href="/assets/js/30.b6b9f227.js"><link rel="prefetch" href="/assets/js/31.d7d6e5fa.js"><link rel="prefetch" href="/assets/js/32.a71c64f7.js"><link rel="prefetch" href="/assets/js/33.6e421306.js"><link rel="prefetch" href="/assets/js/34.0f46b74a.js"><link rel="prefetch" href="/assets/js/35.1d02fd3c.js"><link rel="prefetch" href="/assets/js/36.fc5cc9cb.js"><link rel="prefetch" href="/assets/js/37.af7e5661.js"><link rel="prefetch" href="/assets/js/38.cdd11312.js"><link rel="prefetch" href="/assets/js/39.30bb1d36.js"><link rel="prefetch" href="/assets/js/4.91553c08.js"><link rel="prefetch" href="/assets/js/40.c4740fee.js"><link rel="prefetch" href="/assets/js/41.37a38f62.js"><link rel="prefetch" href="/assets/js/42.df5bcbd7.js"><link rel="prefetch" href="/assets/js/43.0c0ab294.js"><link rel="prefetch" href="/assets/js/44.1dcaa2ac.js"><link rel="prefetch" href="/assets/js/45.c3b4bbca.js"><link rel="prefetch" href="/assets/js/46.7659ce01.js"><link rel="prefetch" href="/assets/js/47.d6eb360d.js"><link rel="prefetch" href="/assets/js/48.ca9d607b.js"><link rel="prefetch" href="/assets/js/49.8c09eac0.js"><link rel="prefetch" href="/assets/js/5.6d5ca1ce.js"><link rel="prefetch" href="/assets/js/50.3694eddb.js"><link rel="prefetch" href="/assets/js/51.0868c6f4.js"><link rel="prefetch" href="/assets/js/52.513df7cc.js"><link rel="prefetch" href="/assets/js/53.9dcabf12.js"><link rel="prefetch" href="/assets/js/54.70a6c075.js"><link rel="prefetch" href="/assets/js/55.a1d14f80.js"><link rel="prefetch" href="/assets/js/56.7029bd26.js"><link rel="prefetch" href="/assets/js/57.1b116307.js"><link rel="prefetch" href="/assets/js/58.bb74acae.js"><link rel="prefetch" href="/assets/js/59.610e7d4f.js"><link rel="prefetch" href="/assets/js/6.ee71a04b.js"><link rel="prefetch" href="/assets/js/60.98e611f4.js"><link rel="prefetch" href="/assets/js/61.05109453.js"><link rel="prefetch" href="/assets/js/62.f4adfb83.js"><link rel="prefetch" href="/assets/js/63.b63e1591.js"><link rel="prefetch" href="/assets/js/64.1235f2bd.js"><link rel="prefetch" href="/assets/js/65.bfa7cab9.js"><link rel="prefetch" href="/assets/js/66.2574fbb1.js"><link rel="prefetch" href="/assets/js/67.09935f72.js"><link rel="prefetch" href="/assets/js/68.af1ee108.js"><link rel="prefetch" href="/assets/js/69.7a2f9a81.js"><link rel="prefetch" href="/assets/js/7.ed4c5699.js"><link rel="prefetch" href="/assets/js/70.605c490c.js"><link rel="prefetch" href="/assets/js/8.c8b45379.js"><link rel="prefetch" href="/assets/js/9.9d028748.js">
    <link rel="stylesheet" href="/assets/css/0.styles.86682925.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">个人文档库</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="http://www.linuxd.cc/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  HOLA
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/LinuxDiary/scripts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  脚本
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="http://www.linuxd.cc/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  HOLA
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/LinuxDiary/scripts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  脚本
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>CentOS</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CentOS/boot_order.html" class="sidebar-link">启动顺序</a></li><li><a href="/CentOS/system_initialization.html" class="sidebar-link">系统常用配置</a></li><li><a href="/CentOS/yum.html" class="sidebar-link">yum命令</a></li><li><a href="/CentOS/rpm.html" class="sidebar-link">rpm命令</a></li><li><a href="/CentOS/date_command_opstions.html" class="sidebar-link">date命令选项</a></li><li><a href="/CentOS/system_logs.html" class="sidebar-link">系统日志说明</a></li><li><a href="/CentOS/grep_sed_awk.html" class="sidebar-link">grep sed awk</a></li><li><a href="/CentOS/file_descriptor.html" class="sidebar-link">文件描述符</a></li><li><a href="/CentOS/stdin_stdout_stderr.html" class="sidebar-link">输入输出重定向</a></li><li><a href="/CentOS/iptables.html" class="sidebar-link">iptables</a></li><li><a href="/CentOS/sysctl.html" class="sidebar-link">sysctl基本优化</a></li><li><a href="/CentOS/load_balance.html" class="sidebar-link">双网卡绑定和负载均衡</a></li><li><a href="/CentOS/lvm.html" class="sidebar-link">lvm管理</a></li><li><a href="/CentOS/sendmail.html" class="sidebar-link">sendmail</a></li><li><a href="/CentOS/dns_server.html" class="sidebar-link">DNS Sever</a></li><li><a href="/CentOS/ftp_server.html" class="sidebar-link">FTP Sever</a></li><li><a href="/CentOS/nfs_server.html" class="sidebar-link">NFS Server</a></li><li><a href="/CentOS/ntp_server.html" class="sidebar-link">NTP Sever</a></li><li><a href="/CentOS/lsyncd.html" class="sidebar-link">lsyncd</a></li><li><a href="/CentOS/kvm_virtulization_deploy.html" aria-current="page" class="active sidebar-link">KVM</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CentOS/kvm_virtulization_deploy.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/CentOS/kvm_virtulization_deploy.html#网络" class="sidebar-link">网络</a></li><li class="sidebar-sub-header"><a href="/CentOS/kvm_virtulization_deploy.html#管理" class="sidebar-link">管理</a></li><li class="sidebar-sub-header"><a href="/CentOS/kvm_virtulization_deploy.html#快照" class="sidebar-link">快照</a></li><li class="sidebar-sub-header"><a href="/CentOS/kvm_virtulization_deploy.html#参考链接" class="sidebar-link">参考链接</a></li></ul></li><li><a href="/CentOS/vmware_extend_disk.html" class="sidebar-link">VMware虚拟机扩展磁盘容量</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Docker</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Docker/docker_app.html" class="sidebar-link">Docker应用</a></li><li><a href="/Docker/docker_compose_app.html" class="sidebar-link">Docker-Compose应用</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Nginx</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Nginx/" class="sidebar-link">介绍</a></li><li><a href="/Nginx/nginx_install.html" class="sidebar-link">安装</a></li><li><a href="/Nginx/nginx_config_files.html" class="sidebar-link">配置文件</a></li><li><a href="/Nginx/nginx_proxy.html" class="sidebar-link">反向代理</a></li><li><a href="/Nginx/nginx_max_clients.html" class="sidebar-link">并发数</a></li><li><a href="/Nginx/linux_optimization_for_nginx.html" class="sidebar-link">内核调优</a></li><li><a href="/Nginx/nginx_php_fpm.html" class="sidebar-link">使用PHP-FPM</a></li><li><a href="/Nginx/keepalived_nginx.html" class="sidebar-link">Keepalived + Nginx</a></li><li><a href="/Nginx/configs.html" class="sidebar-link">常用配置</a></li><li><a href="/Nginx/nginx_log_scripts.html" class="sidebar-link">nginx日志分析</a></li><li><a href="/Nginx/http_code.html" class="sidebar-link">HTTP状态码</a></li><li><a href="/Nginx/error_handle.html" class="sidebar-link">常见错误处理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>MySQL</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/MySQL/" class="sidebar-link">介绍</a></li><li><a href="/MySQL/mysql_installation.html" class="sidebar-link">安装</a></li><li><a href="/MySQL/variables.html" class="sidebar-link">参数</a></li><li><a href="/MySQL/command.html" class="sidebar-link">命令</a></li><li><a href="/MySQL/sql.html" class="sidebar-link">SQL</a></li><li><a href="/MySQL/mysql_scripts.html" class="sidebar-link">脚本</a></li><li><a href="/MySQL/log.html" class="sidebar-link">日志分类</a></li><li><a href="/MySQL/reset_password.html" class="sidebar-link">重置密码</a></li><li><a href="/MySQL/backup.html" class="sidebar-link">备份与恢复</a></li><li><a href="/MySQL/duplication.html" class="sidebar-link">主从复制</a></li><li><a href="/MySQL/optimization.html" class="sidebar-link">运行环境优化</a></li><li><a href="/MySQL/tools.html" class="sidebar-link">实时监控工具</a></li><li><a href="/MySQL/error_code.html" class="sidebar-link">常见错误代码</a></li><li><a href="/MySQL/errors.html" class="sidebar-link">错误处理</a></li><li><a href="/MySQL/innodb.html" class="sidebar-link">InnoDB特性</a></li><li><a href="/MySQL/duplication_case.html" class="sidebar-link">迁移案例</a></li><li><a href="/MySQL/mysql_innodb_cluster.html" class="sidebar-link">MySQL innodb cluster</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Python</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Python/install_python.html" class="sidebar-link">安装</a></li><li><a href="/Python/django_deployment.html" class="sidebar-link">Django项目部署</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Others</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Others/ffmpeg.html" class="sidebar-link">ffmpeg</a></li><li><a href="/Others/mac_tips.html" class="sidebar-link">Mac技巧</a></li><li><a href="/Others/raid_level.html" class="sidebar-link">Raid级别</a></li><li><a href="/Others/servers.html" class="sidebar-link">服务器规划</a></li><li><a href="/Others/memcached.html" class="sidebar-link">Memcached基础</a></li><li><a href="/Others/tomcat_deploy.html" class="sidebar-link">Tomcat部署</a></li><li><a href="/Others/tcp_handshake.html" class="sidebar-link">TCP三次握手四次挥手</a></li><li><a href="/Others/aria2_filebrowser.html" class="sidebar-link">Aria2 离线下载</a></li><li><a href="/Others/word_page_num.html" class="sidebar-link">Word页码编排</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="kvm"><a href="#kvm" class="header-anchor">#</a> KVM</h1> <p>Kernel-based Virtual Machine (KVM) 是 Linux 平台中典型的虚拟化软件，使用 KVM 需要启用 CPU 的 Virtualization Technology (VT) ，通过 <code>lscpu | grep Virtualization</code> 检查是否开启。</p> <h2 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h2> <div class="language-bash extra-class"><pre class="language-bash"><code>yum <span class="token function">install</span> qemu-kvm libvirt libvirt-python libguestfs-tools virt-install
</code></pre></div><p>启动 libvirtd 服务</p> <div class="language-bash extra-class"><pre class="language-bash"><code>systemctl <span class="token builtin class-name">enable</span> libvirtd
systemctl start libvirtd
</code></pre></div><p>检查 KVM 安装情况</p> <div class="language-bash extra-class"><pre class="language-bash"><code>lsmod <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-i</span> kvm
</code></pre></div><h2 id="网络"><a href="#网络" class="header-anchor">#</a> 网络</h2> <p>虚拟网络有 4 种模式: NAT , Route , Bridge , Isolated . 安装并启动后, 会默认生成一个 <code>default</code> 的网络, 同时生成一个虚拟网络接口 <code>virbr0</code> , 并分配 nat 网络 <code>192.168.122.0/24</code></p> <h3 id="默认虚拟网络"><a href="#默认虚拟网络" class="header-anchor">#</a> 默认虚拟网络</h3> <p>使用 <code>brctl show</code> 命令查看宿主机上的接口情况</p> <div class="language-bash extra-class"><pre class="language-bash"><code>bridge name bridge <span class="token function">id</span>       STP enabled interfaces
virbr0      <span class="token number">8000.525400677969</span>   <span class="token function">yes</span>     virbr0-nic
</code></pre></div><p>使用 <code>virsh net-list</code> 命令查看虚拟机管理程序中的接口名称</p> <div class="language-bash extra-class"><pre class="language-bash"><code>Name               State     Autostart  Presistent
----------------------------------------------------------
default            active     <span class="token function">yes</span>          <span class="token function">yes</span>
</code></pre></div><p>使用 <code>virsh net-dumpxml default</code> 查看 <code>default</code> 网络的详细配置, <code>default.xml</code> 文件位于 <code>/usr/share/libvirt/networks</code> , 也可以将配置文件置于 <code>/var/lib/libvirt/networks</code> 下</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>network</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>default<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uuid</span><span class="token punctuation">&gt;</span></span>c935c044-d17a-4e73-8863-7c961d15cf48<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>uuid</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>forward</span> <span class="token attr-name">mode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>nat<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nat</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span> <span class="token attr-name">start</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>1024<span class="token punctuation">'</span></span> <span class="token attr-name">end</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>65535<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nat</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>forward</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bridge</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>virbr0<span class="token punctuation">'</span></span> <span class="token attr-name">stp</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>on<span class="token punctuation">'</span></span> <span class="token attr-name">delay</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mac</span> <span class="token attr-name">address</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>52:54:00:67:79:69<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ip</span> <span class="token attr-name">address</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>192.168.122.1<span class="token punctuation">'</span></span> <span class="token attr-name">netmask</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>255.255.255.0<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dhcp</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>range</span> <span class="token attr-name">start</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>192.168.122.2<span class="token punctuation">'</span></span> <span class="token attr-name">end</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>192.168.122.254<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dhcp</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ip</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>network</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>通过 <code>virsh net-dhcp-leases default</code> 命令查看 <code>default</code> 网络中的 DHCP 地址分配情况 , 通过 <code>virsh help | grep net-</code> 查看可用的网络相关的命令</p> <div class="language-bash extra-class"><pre class="language-bash"><code>Expiry Time          MAC 地址         Protocol  IP address                Hostname        Client ID or DUID
-------------------------------------------------------------------------------------------------------------------
 <span class="token number">2018</span>-01-17 <span class="token number">17</span>:50:02  <span class="token number">52</span>:54:00:1c:2a:e4  ipv4      <span class="token number">192.168</span>.122.181/24        WIN-MV8PO4FNA5M 01:52:54:00:1c:2a:e4
 <span class="token number">2018</span>-01-17 <span class="token number">18</span>:03:01  <span class="token number">52</span>:54:00:7b:d7:9e  ipv4      <span class="token number">192.168</span>.122.207/24        -               -
 <span class="token number">2018</span>-01-17 <span class="token number">17</span>:40:02  <span class="token number">52</span>:54:00:c8:87:ae  ipv4      <span class="token number">192.168</span>.122.51/24         WIN-779HTFV7RP0 01:52:54:00:c8:87:ae
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果虚拟机没有获取到 DHCP 地址,可以 <code>systemctl restart libvirtd</code> 重启一下 <code>libvirtd</code> 服务</p></div> <h3 id="虚拟网络管理"><a href="#虚拟网络管理" class="header-anchor">#</a> 虚拟网络管理</h3> <h4 id="nat"><a href="#nat" class="header-anchor">#</a> NAT</h4> <p>创建一个新的 NAT 虚拟网络. 在 <code>/var/lib/libvirt/networks</code> 下创建配置文件 <code>mynat.xml</code> (如有必要,修改文件权限和所属用户), 根据需要是否启用 <code>dhcp</code> , 不指定 <code>UUID</code> 和 <code>Mac</code> , 启动这个新网络时,系统会自动分配, 注意修改 <code>name</code>, <code>bridge</code> 名称和 <code>IP</code> 地址(范围)</p> <div class="language-xml extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>network</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>mynat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>forward</span> <span class="token attr-name">mode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>nat<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nat</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span> <span class="token attr-name">start</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>1024<span class="token punctuation">'</span></span> <span class="token attr-name">end</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>65535<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nat</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>forward</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bridge</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>virbr1<span class="token punctuation">'</span></span> <span class="token attr-name">stp</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>on<span class="token punctuation">'</span></span> <span class="token attr-name">delay</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ip</span> <span class="token attr-name">address</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>192.168.2.1<span class="token punctuation">'</span></span> <span class="token attr-name">netmask</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>255.255.255.0<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dhcp</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>range</span> <span class="token attr-name">start</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>192.168.2.2<span class="token punctuation">'</span></span> <span class="token attr-name">end</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>192.168.2.254<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dhcp</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ip</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>network</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>创建好配置文件后, 使用配置文件创建并启动一个新的虚拟网络</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">virsh</span> net-define /var/lib/libvirt/networks/mynat.xml
<span class="token function">virsh</span> net-start mynat
<span class="token function">virsh</span> net-autostart mynat
</code></pre></div><p>查看创建好的网络 <code>virsh net-list</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code>Name                 State      Autostart     Persistent
--------------------------------------------------
default              active     <span class="token function">yes</span>           <span class="token function">yes</span>
mynat                active     <span class="token function">yes</span>           <span class="token function">yes</span>
</code></pre></div><p>在虚拟机中使用虚拟网络, 如果是新建虚拟机, 使用如下方式</p> <div class="language-bash extra-class"><pre class="language-bash"><code>virt-install <span class="token parameter variable">--network</span> <span class="token assign-left variable">network</span><span class="token operator">=</span>mynat <span class="token punctuation">..</span>.
</code></pre></div><p>如果是已存在的虚拟机, 通过命令 <code>virsh edit vmDomainName</code> 编辑虚拟机配置文件的 <code>interface</code> 配置中的 <code>source</code> 部分, 如果使用 <code>network</code> 选项, 就使用网络名称 <code>mynat</code> , 如果使用 <code>bridge</code> 选项, 就使用对应的 bridge 名称 <code>virbr1</code></p> <div class="language-xml extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>interface</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>bridge<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mac</span> <span class="token attr-name">address</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>52:54:00:7b:d7:9e<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">network</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>mynat<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>model</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>virtio<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>address</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>pci<span class="token punctuation">'</span></span> <span class="token attr-name">domain</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0x0000<span class="token punctuation">'</span></span> <span class="token attr-name">bus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0x00<span class="token punctuation">'</span></span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0x03<span class="token punctuation">'</span></span> <span class="token attr-name">function</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0x0<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>interface</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>重启虚拟机使配置生效</p> <h4 id="route"><a href="#route" class="header-anchor">#</a> Route</h4> <p>创建一个 Route 虚拟网络, 根据需要是否启用 DHCP , 新建配置文件 <code>/var/lib/libvirt/networks/myroute.xml</code> , 注意修改各项配置</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>network</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>myroute<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>forward</span> <span class="token attr-name">mode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>route<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bridge</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>virbr2<span class="token punctuation">'</span></span> <span class="token attr-name">stp</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>on<span class="token punctuation">'</span></span> <span class="token attr-name">delay</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ip</span> <span class="token attr-name">address</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>192.168.3.1<span class="token punctuation">'</span></span> <span class="token attr-name">netmask</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>255.255.255.0<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dhcp</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>range</span> <span class="token attr-name">start</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>192.168.3.2<span class="token punctuation">'</span></span> <span class="token attr-name">end</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>192.168.3.254<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dhcp</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ip</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>network</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>使用配置文件创建新的虚拟网络</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">virsh</span> net-define /var/lib/libvirt/networks/myroute.xml
<span class="token function">virsh</span> net-start myroute
<span class="token function">virsh</span> net-autostart myroute
</code></pre></div><p>在虚拟机中使用虚拟网络, 如果是新建虚拟机, 使用如下方式</p> <div class="language-bash extra-class"><pre class="language-bash"><code>virt-install <span class="token parameter variable">--network</span> <span class="token assign-left variable">network</span><span class="token operator">=</span>myroute <span class="token punctuation">..</span>.
</code></pre></div><p>如果是已存在的虚拟机, 通过命令 <code>virsh edit vmDomainName</code> 编辑虚拟机配置文件</p> <div class="language-xml extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>interface</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>bridge<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mac</span> <span class="token attr-name">address</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>52:54:00:7b:d7:9e<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">network</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>myroute<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>model</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>virtio<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>address</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>pci<span class="token punctuation">'</span></span> <span class="token attr-name">domain</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0x0000<span class="token punctuation">'</span></span> <span class="token attr-name">bus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0x00<span class="token punctuation">'</span></span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0x03<span class="token punctuation">'</span></span> <span class="token attr-name">function</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0x0<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>interface</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>重启虚拟机使配置生效</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>使用 NAT 和 Route 模式, 需要在 <code>sysctl.conf</code> 中配置如下选项, 否则虚拟机数据包不能被转发</p> <div class="language- extra-class"><pre class="language-text"><code>net.ipv4.ip_forward=1
net.ipv4.conf.all.forwarding=1
</code></pre></div></div> <h4 id="isolated"><a href="#isolated" class="header-anchor">#</a> Isolated</h4> <p>创建一个隔离的虚拟网络, 与 NAT 和 Route 基本一致, 只需取消 <code>&lt;forward&gt;</code> 选项即可, 其他完全一致</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>network</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>myroute<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bridge</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>virbr3<span class="token punctuation">'</span></span> <span class="token attr-name">stp</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>on<span class="token punctuation">'</span></span> <span class="token attr-name">delay</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ip</span> <span class="token attr-name">address</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>192.168.4.1<span class="token punctuation">'</span></span> <span class="token attr-name">netmask</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>255.255.255.0<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dhcp</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>range</span> <span class="token attr-name">start</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>192.168.4.2<span class="token punctuation">'</span></span> <span class="token attr-name">end</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>192.168.4.254<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dhcp</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ip</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>network</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="bridge"><a href="#bridge" class="header-anchor">#</a> Bridge</h4> <p>创建一个与物理物理桥接的网络, 首先安装 <code>bridge-utils</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code>yum <span class="token function">install</span> bridge-utils
</code></pre></div><p>备份原物理网络接口配置文件, 例如 <code>eth0</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">cp</span> /etc/sysconfig/network-scripts/ifcfg-eth0<span class="token punctuation">{</span>,.bak<span class="token punctuation">}</span>
</code></pre></div><p>在配置桥接之前, 在 <code>sysctl.conf</code> 中添加如下选项, 关闭桥接接口上的 <code>iptables</code> 功能, CentOS 7 默认没有加载 <code>br_netfilter</code> 模块, 通过命令 <code>modprobe br_netfilter</code> 加载后, 以下选项才能生效, 否则无需使用以下选项</p> <div class="language- extra-class"><pre class="language-text"><code>net.bridge.bridge-nf-call-ip6tables=0
net.bridge.bridge-nf-call-iptables=0
net.bridge.bridge-nf-call-arptables=0
</code></pre></div><p>编辑要桥接到的物理网络接口. 其中 <code>HWADDR</code> 网卡物理地址可以通过 <code>ip a</code> 或 <code>ifconfig</code> 命令获取, <code>NM_CONTROLLED</code> 设置为 <code>no</code> , 表示不使用 <code>NetworkManager</code> 管理网络</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># /etc/sysconfig/network-scripts/ifcfg-eth0</span>

<span class="token assign-left variable">DEVICE</span><span class="token operator">=</span>eth0
<span class="token assign-left variable">NAME</span><span class="token operator">=</span>eth0
<span class="token assign-left variable">HWADDR</span><span class="token operator">=</span><span class="token number">19</span>:7c:3b:92:ec:ee
<span class="token assign-left variable">NM_CONTROLLED</span><span class="token operator">=</span>no
<span class="token assign-left variable">ONBOOT</span><span class="token operator">=</span>yes
<span class="token assign-left variable">TYPE</span><span class="token operator">=</span>Ethernet
<span class="token assign-left variable">BRIDGE</span><span class="token operator">=</span>br0
</code></pre></div><p>创建桥接网络接口配置文件 , 如果 <code>STP</code> 设置为 <code>off</code> , 可将 <code>DELAY</code> 设置成 <code>0</code> . 其中 <code>ip</code> 配置为原物理网络接口 <code>eth0</code> 的配置</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># /etc/sysconfig/network-scripts/ifcfg-br0</span>

<span class="token assign-left variable">DEVICE</span><span class="token operator">=</span>br0
<span class="token assign-left variable">NAME</span><span class="token operator">=</span>br0
<span class="token assign-left variable">NM_CONTROLLED</span><span class="token operator">=</span>no
<span class="token assign-left variable">ONBOOT</span><span class="token operator">=</span>yes
<span class="token assign-left variable">TYPE</span><span class="token operator">=</span>Bridge
<span class="token assign-left variable">STP</span><span class="token operator">=</span>on
<span class="token assign-left variable">DELAY</span><span class="token operator">=</span><span class="token number">2</span>

<span class="token assign-left variable">IPADDR</span><span class="token operator">=</span><span class="token number">192.168</span>.1.5
<span class="token assign-left variable">PREFIX</span><span class="token operator">=</span><span class="token number">24</span>
<span class="token assign-left variable">GATEWAY</span><span class="token operator">=</span><span class="token number">192.168</span>.1.1
<span class="token assign-left variable">DNS1</span><span class="token operator">=</span><span class="token number">202.103</span>.24.68
</code></pre></div><p>重启网络服务或接口</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">ifdown</span> eth0 <span class="token operator">&amp;&amp;</span> <span class="token function">ifup</span> eth0 <span class="token operator">&amp;&amp;</span> <span class="token function">ifup</span> br0
<span class="token comment"># systemctl restart network</span>
</code></pre></div><p>查看配置好的桥接接口 <code>brctl show br0</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code>bridge name     bridge <span class="token function">id</span>               STP enabled     interfaces
br0             <span class="token number">8000</span>.6c92bf2a6fee       <span class="token function">yes</span>             eth0
</code></pre></div><p>在虚拟机中使用虚拟网络, 如果是新建虚拟机, 使用如下方式</p> <div class="language-bash extra-class"><pre class="language-bash"><code>virt-install <span class="token parameter variable">--network</span> <span class="token assign-left variable">bridge</span><span class="token operator">=</span>br0 <span class="token punctuation">..</span>.
</code></pre></div><p>如果是已存在的虚拟机, 通过命令 <code>virsh edit vmDomainName</code> 编辑虚拟机配置文件</p> <div class="language-xml extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>interface</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>bridge<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mac</span> <span class="token attr-name">address</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>52:54:00:7b:d7:9e<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">bridge</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>br0<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>model</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>virtio<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>address</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>pci<span class="token punctuation">'</span></span> <span class="token attr-name">domain</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0x0000<span class="token punctuation">'</span></span> <span class="token attr-name">bus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0x00<span class="token punctuation">'</span></span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0x03<span class="token punctuation">'</span></span> <span class="token attr-name">function</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0x0<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>interface</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>重新启动虚拟机已生效配置</p> <h2 id="管理"><a href="#管理" class="header-anchor">#</a> 管理</h2> <h3 id="创建虚拟机"><a href="#创建虚拟机" class="header-anchor">#</a> 创建虚拟机</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>virt-install <span class="token punctuation">\</span>
--virt-type<span class="token operator">=</span>kvm <span class="token punctuation">\</span>
<span class="token parameter variable">--name</span> centos7 <span class="token punctuation">\</span>
<span class="token parameter variable">--ram</span> <span class="token number">2048</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--vcpus</span><span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">\</span>
--os-variant<span class="token operator">=</span>centos7.0 <span class="token punctuation">\</span>
<span class="token parameter variable">--cdrom</span><span class="token operator">=</span>/var/lib/libvirt/boot/CentOS-7-x86_64-Minimal-1810.iso <span class="token punctuation">\</span>
<span class="token parameter variable">--network</span> <span class="token assign-left variable">bridge</span><span class="token operator">=</span>virbr0,model<span class="token operator">=</span>virtio <span class="token punctuation">\</span>
<span class="token parameter variable">--graphics</span> vnc <span class="token punctuation">\</span>
<span class="token parameter variable">--disk</span> <span class="token assign-left variable">path</span><span class="token operator">=</span>/var/lib/libvirt/images/centos7.qcow2,size<span class="token operator">=</span><span class="token number">40</span>,bus<span class="token operator">=</span>virtio,format<span class="token operator">=</span>qcow2
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><code>--os-variant</code> 指定发行版本,可通过 <code>osinfo-query os</code> 命令查看详细的操作系统发行版本列表.可以添加 <code>--vncport=5994</code> 选项指定 vnc 的监听端口, 添加 <code>--vnclisten=0.0.0.0</code> 选项指定 vnc 的监听地址,没有指定时系统将默认从 <code>5900</code> 开始分配,IP 为 <code>127.0.0.1</code></p></div> <p>如果没有开始安装就意外退出了虚拟机,再次启动时可能会提示 <code>no bootable device</code> , 这是因为没有挂载到 cdrom ,此时需要编辑虚拟机配置文件 <code>virsh edit centos7</code> ,将 cdrom 添加到启动项,并确保配置文件中已经包含了 cdrom 的配置信息</p> <div class="language-xml extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>disk</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>file<span class="token punctuation">'</span></span> <span class="token attr-name">device</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>cdrom<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>driver</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>qemu<span class="token punctuation">'</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>raw<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/var/lib/libvirt/boot/CentOS-7-x86_64-Minimal-1810.iso<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span> <span class="token attr-name">dev</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>hda<span class="token punctuation">'</span></span> <span class="token attr-name">bus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>ide<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>readonly</span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>address</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>drive<span class="token punctuation">'</span></span> <span class="token attr-name">controller</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0<span class="token punctuation">'</span></span> <span class="token attr-name">bus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0<span class="token punctuation">'</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0<span class="token punctuation">'</span></span> <span class="token attr-name">unit</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>disk</span><span class="token punctuation">&gt;</span></span>
...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>os</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span> <span class="token attr-name">arch</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>x86_64<span class="token punctuation">'</span></span> <span class="token attr-name">machine</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>pc-0.12<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>hvm<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>boot</span> <span class="token attr-name">dev</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>hd<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>boot</span> <span class="token attr-name">dev</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>cdrom<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>os</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>系统没有安装图形化界面,因此创建虚拟机成功后可能出现以下提示</p> <div class="language-bash extra-class"><pre class="language-bash"><code>WARNING  Unable to connect to graphical console: virt-viewer not installed. Please <span class="token function">install</span> the <span class="token string">'virt-viewer'</span> package.
WARNING  No console to launch <span class="token keyword">for</span> the guest, defaulting to <span class="token parameter variable">--wait</span> <span class="token parameter variable">-1</span>

Starting install<span class="token punctuation">..</span>.
Allocating <span class="token string">'centostest.qcow2'</span>                               <span class="token operator">|</span>  <span class="token number">40</span> GB  00:00     
Domain installation still <span class="token keyword">in</span> progress. Waiting <span class="token keyword">for</span> installation to complete.
</code></pre></div><p>另外,如果当前使用的终端工具(例如 Mac 系统下使用了中文编码)是中文编码,那么在虚拟机创建完成后启动时会出现如下错误,不影响使用</p> <div class="language-bash extra-class"><pre class="language-bash"><code>ERROR    unsupported <span class="token function">format</span> character <span class="token string">'�'</span> <span class="token punctuation">(</span>0xffffffe7<span class="token punctuation">)</span> at index <span class="token number">47</span>
</code></pre></div><h3 id="连接虚拟机"><a href="#连接虚拟机" class="header-anchor">#</a> 连接虚拟机</h3> <p>如果创建过程中没有指定 vnc 端口,系统会默认从端口 <code>5900</code> 开始分配, IP 为 <code>127.0.0.1</code> ,通过 <code>virsh dumpxml centos7 | grep vnc</code> 查看分配的 vnc 信息, <code>centos7</code> 是创建时定义的 VM 名称</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>graphics</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>vnc<span class="token punctuation">'</span></span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>5900<span class="token punctuation">'</span></span> <span class="token attr-name">autoport</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>yes<span class="token punctuation">'</span></span> <span class="token attr-name">listen</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>127.0.0.1<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>通过 ssh 隧道连接创建好的虚拟机,首先建立隧道</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">ssh</span> <span class="token parameter variable">-p</span> PORT root@IP <span class="token parameter variable">-L</span> <span class="token number">5900</span>:127.0.0.1:5900
</code></pre></div><p>然后就可以在本地使用 vnc 客户端通过 <code>127.0.0.1:5900</code> 连接到远程虚拟机了</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果使用类似 <code>Jump Desktop</code> 的终端管理软件,可以直接将 ssh 隧道连接信息填到配置中,以后就可以直接连接了</p></div> <h3 id="常用-virsh-命令"><a href="#常用-virsh-命令" class="header-anchor">#</a> 常用 virsh 命令</h3> <table><thead><tr><th>命令</th> <th>描述</th></tr></thead> <tbody><tr><td>virsh list --all</td> <td>列出所有虚拟机</td></tr> <tr><td>virsh dominfo vmName</td> <td>查看虚拟机信息</td></tr> <tr><td>virsh shutdown vmName</td> <td>正常关闭虚拟机</td></tr> <tr><td>virsh start vmName</td> <td>启动虚拟机</td></tr> <tr><td>virsh autostart vmName</td> <td>设置虚拟机自动启动</td></tr> <tr><td>virsh reboot vmName</td> <td>重启虚拟机</td></tr></tbody></table> <p>删除虚拟机方法</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">virsh</span> <span class="token function">shutdown</span> vmName  <span class="token comment"># virsh destory vmName</span>
<span class="token function">virsh</span> undefine vmName
<span class="token function">rm</span> <span class="token parameter variable">-ri</span> /var/lib/libvirt/images/IMAGE.qcow2
</code></pre></div><h3 id="维护虚拟机"><a href="#维护虚拟机" class="header-anchor">#</a> 维护虚拟机</h3> <h4 id="管理-cdrom"><a href="#管理-cdrom" class="header-anchor">#</a> 管理 cdrom</h4> <p>首先查看虚拟机上挂载了哪些 disk ,通过命令 <code>virsh domblklist wintest</code> , wintest 是虚拟机名称</p> <div class="language-bash extra-class"><pre class="language-bash"><code>vda        /var/lib/libvirt/images/wintest.qcow2
hda        /var/lib/libvirt/boot/virtio-win-0.1.102.iso
</code></pre></div><p>弹出光盘</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">virsh</span> change-media wintest hda <span class="token parameter variable">--eject</span>
</code></pre></div><p>再次查看 disk 信息</p> <div class="language-bash extra-class"><pre class="language-bash"><code>vda        /var/lib/libvirt/images/wintest.qcow2
hda        -
</code></pre></div><p>挂载新的 ISO 镜像,也可以是宿主机的光驱设备,例如 <code>/dev/sr0</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">virsh</span> change-media wintest hda /var/lib/libvirt/boot/virtio-win-0.1.102.iso <span class="token parameter variable">--insert</span>
<span class="token comment"># virsh change-media wintest hda /dev/sr0 --insert</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>libvirt 不支持 cdrom 的热插拔操作,因此不能通过 <code>virsh attach-disk</code> 命令添加 cdrom 设备,添加时会报如下错误</p> <div class="language-bash extra-class"><pre class="language-bash"><code>error: Failed to attach disk
error: internal error: No device with bus <span class="token string">'ide'</span> and target <span class="token string">'hdc'</span><span class="token builtin class-name">.</span> cdrom and floppy device hotplug isn't supported by libvirt
</code></pre></div></div> <h4 id="添加或删除虚拟磁盘"><a href="#添加或删除虚拟磁盘" class="header-anchor">#</a> 添加或删除虚拟磁盘</h4> <p>首先创建一个空的虚拟磁盘</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># /var/lib/libvirt/images</span>

qemu-img create <span class="token parameter variable">-f</span> raw centos7-1.img 10G
</code></pre></div><p>查看创建好的虚拟磁盘 <code>ll -h</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code>-rw-r--r--. <span class="token number">1</span> root root 10G <span class="token number">1</span>月  <span class="token number">17</span> <span class="token number">16</span>:50 centos7-1.img
</code></pre></div><p>创建好虚拟磁盘后,通过命令 <code>df -h</code> 命令检查虚拟机中的磁盘名称</p> <p>将磁盘添加到虚拟机中,通过如下命令添加到虚拟机中,指定一个虚拟机中未被使用的磁盘名称,例如 <code>vdb</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">virsh</span> attach-disk centos7 <span class="token parameter variable">--source</span> /var/lib/libvirt/images/centos7-1.img <span class="token parameter variable">--target</span> vdb <span class="token parameter variable">--persistent</span>
</code></pre></div><p>指定 <code>--persistent</code> 选项让配置持久化生效,相应的会把更改写入到虚拟机配置文件中</p> <p>取消附加磁盘使用如下命令</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">virsh</span> detach-disk centos7 /var/lib/libvirt/images/centos7-1.img <span class="token parameter variable">--persistent</span>
</code></pre></div><h2 id="快照"><a href="#快照" class="header-anchor">#</a> 快照</h2> <p>创建一个快照</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">virsh</span> snapshot-create-as centos7 <span class="token parameter variable">--name</span> <span class="token string">'snapshot1'</span> <span class="token parameter variable">--description</span> <span class="token string">'xxx'</span>
</code></pre></div><p>查看快照 <code>virsh snapshot-list centos7</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code>Name                 Creation Time             State
------------------------------------------------------------
snapshot1              <span class="token number">2018</span>-01-21 <span class="token number">14</span>:37:48 +0800 running
</code></pre></div><p>恢复到快照</p> <div class="language-bash extra-class"><pre class="language-bash"><code>snapshot-revert centos7 snapshot1
</code></pre></div><p>删除一个快照</p> <div class="language-bash extra-class"><pre class="language-bash"><code>snapshot-delete centos7 snapshot1
</code></pre></div><h2 id="参考链接"><a href="#参考链接" class="header-anchor">#</a> 参考链接</h2> <ul><li><a href="https://www.cyberciti.biz/faq/how-to-install-kvm-on-centos-7-rhel-7-headless-server/" target="_blank" rel="noopener noreferrer">https://www.cyberciti.biz/faq/how-to-install-kvm-on-centos-7-rhel-7-headless-server/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://mycfg.net/articles/booting-from-a-cdrom-in-a-kvm-guest-with-libvirt.html" target="_blank" rel="noopener noreferrer">http://mycfg.net/articles/booting-from-a-cdrom-in-a-kvm-guest-with-libvirt.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://kashyapc.fedorapeople.org/virt/create-a-new-libvirt-bridge.txt" target="_blank" rel="noopener noreferrer">https://kashyapc.fedorapeople.org/virt/create-a-new-libvirt-bridge.txt<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/CentOS/lsyncd.html" class="prev">
        lsyncd
      </a></span> <span class="next"><a href="/CentOS/vmware_extend_disk.html">
        VMware虚拟机扩展磁盘容量
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.6ea617b8.js" defer></script><script src="/assets/js/2.6e381248.js" defer></script><script src="/assets/js/17.7976f036.js" defer></script>
  </body>
</html>
