<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Keepalived + Nginx | 个人文档库</title>
    <meta name="generator" content="VuePress 1.9.8">
    
    <meta name="description" content="运维知识文档">
    
    <link rel="preload" href="/assets/css/0.styles.86682925.css" as="style"><link rel="preload" href="/assets/js/app.6ea617b8.js" as="script"><link rel="preload" href="/assets/js/2.6e381248.js" as="script"><link rel="preload" href="/assets/js/54.70a6c075.js" as="script"><link rel="prefetch" href="/assets/js/10.dd27a2bb.js"><link rel="prefetch" href="/assets/js/11.ec440828.js"><link rel="prefetch" href="/assets/js/12.c67fbef0.js"><link rel="prefetch" href="/assets/js/13.a53b31f6.js"><link rel="prefetch" href="/assets/js/14.fac02fcf.js"><link rel="prefetch" href="/assets/js/15.366e462e.js"><link rel="prefetch" href="/assets/js/16.ae609dff.js"><link rel="prefetch" href="/assets/js/17.7976f036.js"><link rel="prefetch" href="/assets/js/18.3f258419.js"><link rel="prefetch" href="/assets/js/19.0ad2626e.js"><link rel="prefetch" href="/assets/js/20.bdf3dbe2.js"><link rel="prefetch" href="/assets/js/21.04180477.js"><link rel="prefetch" href="/assets/js/22.f4cf519a.js"><link rel="prefetch" href="/assets/js/23.9e5b52cd.js"><link rel="prefetch" href="/assets/js/24.b0159ef8.js"><link rel="prefetch" href="/assets/js/25.e38d986a.js"><link rel="prefetch" href="/assets/js/26.b44e8359.js"><link rel="prefetch" href="/assets/js/27.164897ca.js"><link rel="prefetch" href="/assets/js/28.30c3dcb6.js"><link rel="prefetch" href="/assets/js/29.0ea1763d.js"><link rel="prefetch" href="/assets/js/3.87c14ff3.js"><link rel="prefetch" href="/assets/js/30.b6b9f227.js"><link rel="prefetch" href="/assets/js/31.d7d6e5fa.js"><link rel="prefetch" href="/assets/js/32.a71c64f7.js"><link rel="prefetch" href="/assets/js/33.6e421306.js"><link rel="prefetch" href="/assets/js/34.0f46b74a.js"><link rel="prefetch" href="/assets/js/35.1d02fd3c.js"><link rel="prefetch" href="/assets/js/36.fc5cc9cb.js"><link rel="prefetch" href="/assets/js/37.af7e5661.js"><link rel="prefetch" href="/assets/js/38.cdd11312.js"><link rel="prefetch" href="/assets/js/39.30bb1d36.js"><link rel="prefetch" href="/assets/js/4.91553c08.js"><link rel="prefetch" href="/assets/js/40.c4740fee.js"><link rel="prefetch" href="/assets/js/41.37a38f62.js"><link rel="prefetch" href="/assets/js/42.df5bcbd7.js"><link rel="prefetch" href="/assets/js/43.0c0ab294.js"><link rel="prefetch" href="/assets/js/44.1dcaa2ac.js"><link rel="prefetch" href="/assets/js/45.c3b4bbca.js"><link rel="prefetch" href="/assets/js/46.7659ce01.js"><link rel="prefetch" href="/assets/js/47.d6eb360d.js"><link rel="prefetch" href="/assets/js/48.ca9d607b.js"><link rel="prefetch" href="/assets/js/49.8c09eac0.js"><link rel="prefetch" href="/assets/js/5.6d5ca1ce.js"><link rel="prefetch" href="/assets/js/50.3694eddb.js"><link rel="prefetch" href="/assets/js/51.0868c6f4.js"><link rel="prefetch" href="/assets/js/52.513df7cc.js"><link rel="prefetch" href="/assets/js/53.9dcabf12.js"><link rel="prefetch" href="/assets/js/55.a1d14f80.js"><link rel="prefetch" href="/assets/js/56.7029bd26.js"><link rel="prefetch" href="/assets/js/57.1b116307.js"><link rel="prefetch" href="/assets/js/58.bb74acae.js"><link rel="prefetch" href="/assets/js/59.610e7d4f.js"><link rel="prefetch" href="/assets/js/6.ee71a04b.js"><link rel="prefetch" href="/assets/js/60.98e611f4.js"><link rel="prefetch" href="/assets/js/61.05109453.js"><link rel="prefetch" href="/assets/js/62.f4adfb83.js"><link rel="prefetch" href="/assets/js/63.b63e1591.js"><link rel="prefetch" href="/assets/js/64.1235f2bd.js"><link rel="prefetch" href="/assets/js/65.bfa7cab9.js"><link rel="prefetch" href="/assets/js/66.2574fbb1.js"><link rel="prefetch" href="/assets/js/67.09935f72.js"><link rel="prefetch" href="/assets/js/68.af1ee108.js"><link rel="prefetch" href="/assets/js/69.7a2f9a81.js"><link rel="prefetch" href="/assets/js/7.ed4c5699.js"><link rel="prefetch" href="/assets/js/70.605c490c.js"><link rel="prefetch" href="/assets/js/8.c8b45379.js"><link rel="prefetch" href="/assets/js/9.9d028748.js">
    <link rel="stylesheet" href="/assets/css/0.styles.86682925.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">个人文档库</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="http://www.linuxd.cc/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  HOLA
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/LinuxDiary/scripts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  脚本
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="http://www.linuxd.cc/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  HOLA
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/LinuxDiary/scripts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  脚本
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>CentOS</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CentOS/boot_order.html" class="sidebar-link">启动顺序</a></li><li><a href="/CentOS/system_initialization.html" class="sidebar-link">系统常用配置</a></li><li><a href="/CentOS/yum.html" class="sidebar-link">yum命令</a></li><li><a href="/CentOS/rpm.html" class="sidebar-link">rpm命令</a></li><li><a href="/CentOS/date_command_opstions.html" class="sidebar-link">date命令选项</a></li><li><a href="/CentOS/system_logs.html" class="sidebar-link">系统日志说明</a></li><li><a href="/CentOS/grep_sed_awk.html" class="sidebar-link">grep sed awk</a></li><li><a href="/CentOS/file_descriptor.html" class="sidebar-link">文件描述符</a></li><li><a href="/CentOS/stdin_stdout_stderr.html" class="sidebar-link">输入输出重定向</a></li><li><a href="/CentOS/iptables.html" class="sidebar-link">iptables</a></li><li><a href="/CentOS/sysctl.html" class="sidebar-link">sysctl基本优化</a></li><li><a href="/CentOS/load_balance.html" class="sidebar-link">双网卡绑定和负载均衡</a></li><li><a href="/CentOS/lvm.html" class="sidebar-link">lvm管理</a></li><li><a href="/CentOS/sendmail.html" class="sidebar-link">sendmail</a></li><li><a href="/CentOS/dns_server.html" class="sidebar-link">DNS Sever</a></li><li><a href="/CentOS/ftp_server.html" class="sidebar-link">FTP Sever</a></li><li><a href="/CentOS/nfs_server.html" class="sidebar-link">NFS Server</a></li><li><a href="/CentOS/ntp_server.html" class="sidebar-link">NTP Sever</a></li><li><a href="/CentOS/lsyncd.html" class="sidebar-link">lsyncd</a></li><li><a href="/CentOS/kvm_virtulization_deploy.html" class="sidebar-link">KVM</a></li><li><a href="/CentOS/vmware_extend_disk.html" class="sidebar-link">VMware虚拟机扩展磁盘容量</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Docker</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Docker/docker_app.html" class="sidebar-link">Docker应用</a></li><li><a href="/Docker/docker_compose_app.html" class="sidebar-link">Docker-Compose应用</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Nginx</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Nginx/" aria-current="page" class="sidebar-link">介绍</a></li><li><a href="/Nginx/nginx_install.html" class="sidebar-link">安装</a></li><li><a href="/Nginx/nginx_config_files.html" class="sidebar-link">配置文件</a></li><li><a href="/Nginx/nginx_proxy.html" class="sidebar-link">反向代理</a></li><li><a href="/Nginx/nginx_max_clients.html" class="sidebar-link">并发数</a></li><li><a href="/Nginx/linux_optimization_for_nginx.html" class="sidebar-link">内核调优</a></li><li><a href="/Nginx/nginx_php_fpm.html" class="sidebar-link">使用PHP-FPM</a></li><li><a href="/Nginx/keepalived_nginx.html" aria-current="page" class="active sidebar-link">Keepalived + Nginx</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Nginx/keepalived_nginx.html#拓扑" class="sidebar-link">拓扑</a></li><li class="sidebar-sub-header"><a href="/Nginx/keepalived_nginx.html#部署" class="sidebar-link">部署</a></li><li class="sidebar-sub-header"><a href="/Nginx/keepalived_nginx.html#nginx服务检测脚本" class="sidebar-link">Nginx服务检测脚本</a></li><li class="sidebar-sub-header"><a href="/Nginx/keepalived_nginx.html#selinux" class="sidebar-link">SELINUX</a></li><li class="sidebar-sub-header"><a href="/Nginx/keepalived_nginx.html#防火墙" class="sidebar-link">防火墙</a></li><li class="sidebar-sub-header"><a href="/Nginx/keepalived_nginx.html#vip漂移" class="sidebar-link">VIP漂移</a></li><li class="sidebar-sub-header"><a href="/Nginx/keepalived_nginx.html#参考链接" class="sidebar-link">参考链接</a></li></ul></li><li><a href="/Nginx/configs.html" class="sidebar-link">常用配置</a></li><li><a href="/Nginx/nginx_log_scripts.html" class="sidebar-link">nginx日志分析</a></li><li><a href="/Nginx/http_code.html" class="sidebar-link">HTTP状态码</a></li><li><a href="/Nginx/error_handle.html" class="sidebar-link">常见错误处理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>MySQL</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/MySQL/" class="sidebar-link">介绍</a></li><li><a href="/MySQL/mysql_installation.html" class="sidebar-link">安装</a></li><li><a href="/MySQL/variables.html" class="sidebar-link">参数</a></li><li><a href="/MySQL/command.html" class="sidebar-link">命令</a></li><li><a href="/MySQL/sql.html" class="sidebar-link">SQL</a></li><li><a href="/MySQL/mysql_scripts.html" class="sidebar-link">脚本</a></li><li><a href="/MySQL/log.html" class="sidebar-link">日志分类</a></li><li><a href="/MySQL/reset_password.html" class="sidebar-link">重置密码</a></li><li><a href="/MySQL/backup.html" class="sidebar-link">备份与恢复</a></li><li><a href="/MySQL/duplication.html" class="sidebar-link">主从复制</a></li><li><a href="/MySQL/optimization.html" class="sidebar-link">运行环境优化</a></li><li><a href="/MySQL/tools.html" class="sidebar-link">实时监控工具</a></li><li><a href="/MySQL/error_code.html" class="sidebar-link">常见错误代码</a></li><li><a href="/MySQL/errors.html" class="sidebar-link">错误处理</a></li><li><a href="/MySQL/innodb.html" class="sidebar-link">InnoDB特性</a></li><li><a href="/MySQL/duplication_case.html" class="sidebar-link">迁移案例</a></li><li><a href="/MySQL/mysql_innodb_cluster.html" class="sidebar-link">MySQL innodb cluster</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Python</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Python/install_python.html" class="sidebar-link">安装</a></li><li><a href="/Python/django_deployment.html" class="sidebar-link">Django项目部署</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Others</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Others/ffmpeg.html" class="sidebar-link">ffmpeg</a></li><li><a href="/Others/mac_tips.html" class="sidebar-link">Mac技巧</a></li><li><a href="/Others/raid_level.html" class="sidebar-link">Raid级别</a></li><li><a href="/Others/servers.html" class="sidebar-link">服务器规划</a></li><li><a href="/Others/memcached.html" class="sidebar-link">Memcached基础</a></li><li><a href="/Others/tomcat_deploy.html" class="sidebar-link">Tomcat部署</a></li><li><a href="/Others/tcp_handshake.html" class="sidebar-link">TCP三次握手四次挥手</a></li><li><a href="/Others/aria2_filebrowser.html" class="sidebar-link">Aria2 离线下载</a></li><li><a href="/Others/word_page_num.html" class="sidebar-link">Word页码编排</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="keepalived-nginx"><a href="#keepalived-nginx" class="header-anchor">#</a> Keepalived + Nginx</h1> <h2 id="拓扑"><a href="#拓扑" class="header-anchor">#</a> 拓扑</h2> <p><code>Nginx</code> 作为负载均衡分发客户端请求到后端 <code>web</code> 服务器， <code>Keepalived</code> 为 <code>Nginx</code> 提供高可用。</p> <div class="language- extra-class"><pre class="language-text"><code>                           +-------------+
                           |    Client   |
                           +-------------+
                                  |
                                  +
            MASTER            keepalived         BACKUP
          192.168.2.16      192.168.2.200      192.168.2.19
        +-------------+    +-------------+    +-------------+
        |   nginx01   |----|  virtualIP  |----|   nginx02   |
        +-------------+    +-------------+    +-------------+
                                  |
               +------------------+------------------+
               |                  |                  |
        +-------------+    +-------------+    +-------------+
        |    web01    |    |    web02    |    |    web03    |
        +-------------+    +-------------+    +-------------+
</code></pre></div><h2 id="部署"><a href="#部署" class="header-anchor">#</a> 部署</h2> <h3 id="安装keepalived"><a href="#安装keepalived" class="header-anchor">#</a> 安装keepalived</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> keepalived
</code></pre></div><h3 id="配置"><a href="#配置" class="header-anchor">#</a> 配置</h3> <p><code>MASTER</code> 节点的 <code>keepalived.conf</code></p> <div class="language- extra-class"><pre class="language-text"><code>! Configuration File for keepalived
global_defs {
    notification_email {
        admin@example.com
    }
    notification_email_from admin@example.com
    smtp_server mail.example.com
    smtp_connect_timeout 30
    router_id LVS_DEVEL
}

vrrp_script chk_nginx {
    script &quot;/usr/libexec/keepalived/check_nginx.sh&quot;
    interval 5
    weight -5
    fall 2  
    rise 1
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    mcast_src_ip 192.168.2.16
    virtual_router_id 51
    priority 101
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        192.168.2.200
    }
    track_script {
       chk_nginx
    }
}
</code></pre></div><p><code>BACKUP</code> 节点的 <code>keepalived.conf</code> 与 <code>MASTER</code> 一致，其中有几项不同</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 节点的初始状态</span>
state MASTER -<span class="token operator">&gt;</span> state BACKUP

<span class="token comment"># BACKUP 节点的初始优先级小于 MASTER</span>
priority <span class="token number">101</span> -<span class="token operator">&gt;</span> priority <span class="token number">100</span>

<span class="token comment"># 发送多播数据表的源 IP 地址</span>
mcast_src_ip <span class="token number">192.168</span>.2.16 -<span class="token operator">&gt;</span> mcast_src_ip <span class="token number">192.168</span>.2.19
</code></pre></div><h3 id="主要配置选项"><a href="#主要配置选项" class="header-anchor">#</a> 主要配置选项</h3> <p><strong>vrrp_instance</strong></p> <ul><li>state ： <code>VRRP</code> 实例的初始状态， <code>MASTER</code> 或 <code>BACKUP</code></li> <li>interface ： 指定实例绑定的网卡接口</li> <li>mcast_src_ip ： 发送多播数据包时的源IP地址，可以使用 <code>interface</code> 指定的网卡地址，但最好单独配置一块网卡专用于发送 <code>VRRP</code> 通告</li> <li>virtual_router_id ： <code>VRID</code> ，相同的 <code>VRID</code> 为一个组，决定了多播的 <code>MAC</code> 地址</li> <li>priority ： 本节点的优先级，优先级高的为 <code>MASTER</code></li> <li>advert_int ： <code>VRRP</code> 通告发送时间间隔</li> <li>authentication ： 定义认证方式和密码，主从保持一致</li> <li>virtual_ipaddress ： <code>VIP</code> ，随着 <code>state</code> 的变化而增加删除，当 <code>state</code> 为 <code>MASTER</code> 的时候就添加，当 <code>state</code> 为 <code>BACKUP</code> 的时候删除， <code>state</code> 主要由优先级来决定，可以设置多个 <code>IP</code></li> <li>track_script ： 引用 <code>VRRP</code> 脚本，即在 <code>vrrp_script</code> 块中指定的名字。定期运行它们来改变优先级，并最终引发主备切换。</li></ul> <p><strong>vrrp_script</strong></p> <ul><li>script ： 检测脚本，也可以是一行命令 <code>killall -0 nginx</code> 。这里根据脚本执行的状态码来判断检测成功或者失败，为 <code>0</code> 即成功，并且如果 <code>weight</code> 大于 <code>0</code> 则优先级增加；非 <code>0</code> 即失败，并且如果 <code>weight</code> 小于 <code>0</code> ，则优先级减小。</li> <li>interval 2 ： 每 <code>2s</code> 检测一次</li> <li>weight -5 ： 检测失败（脚本返回非0）则优先级 <code>-5</code></li> <li>fall 2 ： 检测连续 <code>2</code> 次失败才算确定是真失败，失败后减少优先级</li> <li>rise 1 ： 检测 <code>1</code> 次成功就算成功，但不修改优先级</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>可以设置多个检测脚本，即多个 <code>vrrp_script</code> 块，从多方面监测 <code>Keepalived</code> 节点。 <code>interval</code> 设定的时间必须大于脚本运行的时间，如果脚本中有 <code>sleep</code> 命令，需要适当调整 <code>interval</code> 时间，否则可能会报错 <code>exited due to signal 15</code></p></div> <h2 id="nginx服务检测脚本"><a href="#nginx服务检测脚本" class="header-anchor">#</a> Nginx服务检测脚本</h2> <p><code>Keepalived</code> 默认只能支持服务器级别的高可用，而不能实现应用级的高可用，但是可以通过 <code>track_script</code> 选项来监测脚本的执行状态，然后由 <code>vrrp_script</code> 中的选项对节点的优先级进行动态修改，以达到 <code>VIP</code> 漂移的目的，变相实现对应用的高可用监测，编辑脚本 <code>/usr/libexec/keepalived/check_nginx.sh</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">))</span></span>
<span class="token keyword">do</span>
    <span class="token assign-left variable">check_code</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> --connect-timeout <span class="token number">3</span> <span class="token parameter variable">-sL</span> <span class="token parameter variable">-w</span> <span class="token string">&quot;%{http_code}<span class="token entity" title="\\">\\</span>n&quot;</span> http://localhost:8008 <span class="token parameter variable">-o</span> /dev/null<span class="token variable">)</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$check_code</span> <span class="token operator">!=</span> <span class="token string">&quot;200&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
        <span class="token assign-left variable">count</span><span class="token operator">+=</span><span class="token number">1</span>
        <span class="token function">sleep</span> <span class="token number">2</span>
        <span class="token builtin class-name">continue</span>
    <span class="token keyword">else</span>
        <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">0</span>
        <span class="token builtin class-name">break</span>
    <span class="token keyword">fi</span>
<span class="token keyword">done</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$count</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
    <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">else</span>
    <span class="token builtin class-name">exit</span> <span class="token number">0</span>
<span class="token keyword">fi</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">chmod</span> <span class="token number">755</span> /usr/libexec/keepalived/check_nginx.sh
ll <span class="token parameter variable">-Z</span> /usr/libexec/keepalived/check_nginx.sh
-rwxr-xr-x. root root unconfined_u:object_r:keepalived_unconfined_script_exec_t:s0 /usr/libexec/keepalived/check_nginx.sh
</code></pre></div><p>脚本连续访问主页 <code>2</code> 次，如果没有返回 <code>http 200</code> 状态，表示网站无法访问(不一定是 <code>Nginx</code> 宕机)，如果检查失败，则返回状态码 <code>1</code> ，相应的 <code>Keepalived</code> 减少优先级，重新选举 <code>MASTER</code> ，由新的 <code>MASTER</code> 接管客户端请求。</p> <h2 id="selinux"><a href="#selinux" class="header-anchor">#</a> SELINUX</h2> <p>在开启了 <code>SELINUX</code> 的情况下，检测脚本需要在 <code>/usr/libexec/keepalived/</code> 目录下创建， <code>Keepalived</code> 才能执行脚本</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> semanage fcontext <span class="token parameter variable">-l</span> <span class="token operator">|</span> <span class="token function">grep</span> keepalived_unconfined_script_exec_t
/usr/libexec/keepalived<span class="token punctuation">(</span>/.*<span class="token punctuation">)</span>?                      all files          system_u:object_r:keepalived_unconfined_script_exec_t:s0
</code></pre></div><p>如果使用其他目录，需要配置安全上下文，当然也可以关闭 <code>SELINUX</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 临时生效</span>
$ <span class="token function">sudo</span> chcon <span class="token parameter variable">-t</span> keepalived_unconfined_script_exec_t /root/check_nginx.sh

<span class="token comment"># 永久生效</span>
$ <span class="token function">sudo</span> semanage fcontext <span class="token parameter variable">-a</span> <span class="token parameter variable">-t</span> pubic_content_t <span class="token string">'/root/keepalived(/.*)?'</span>
$ <span class="token function">sudo</span> restorecon <span class="token parameter variable">-Rv</span> <span class="token string">'/root/keepalived/'</span>
</code></pre></div><h2 id="防火墙"><a href="#防火墙" class="header-anchor">#</a> 防火墙</h2> <p>节点之间要相互发送 <code>VRRP</code> 通告，如果使用了 <code>iptables</code> ，需要在添加放行 <code>VRRP</code> 和 访问 多播地址 <code>224.0.0.18</code> 的规则，否则可能产生裂脑问题，多个节点同时接管 <code>VIP</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code>iptables <span class="token parameter variable">-I</span> INPUT <span class="token number">5</span> <span class="token parameter variable">-s</span> <span class="token number">192.168</span>.2.0/24 <span class="token parameter variable">-d</span> <span class="token number">224.0</span>.0.18 <span class="token parameter variable">-j</span> ACCEPT
iptables <span class="token parameter variable">-I</span> INPUT <span class="token number">5</span> <span class="token parameter variable">-s</span> <span class="token number">192.168</span>.2.0/24 <span class="token parameter variable">-p</span> vrrp <span class="token parameter variable">-j</span> ACCEPT
iptables-save <span class="token operator">&gt;</span>/etc/sysconfig/iptables
</code></pre></div><h2 id="vip漂移"><a href="#vip漂移" class="header-anchor">#</a> VIP漂移</h2> <p>在 <code>Nginx</code> 服务都正常的情况下， <code>VIP</code> 位于优先级高的 <code>MASTER</code> 上</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># MASTER</span>
$ <span class="token function">ip</span> a <span class="token operator">|</span> <span class="token function">grep</span> eth0
<span class="token number">2</span>: eth0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UP qlen <span class="token number">1000</span>
    inet <span class="token number">192.168</span>.2.16/24 brd <span class="token number">192.168</span>.2.255 scope global eth0
    inet <span class="token number">192.168</span>.2.200/32 scope global eth0

<span class="token comment"># BACKUP</span>
$ <span class="token function">ip</span> a <span class="token operator">|</span> <span class="token function">grep</span> eth0
<span class="token number">2</span>: eth0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UP qlen <span class="token number">1000</span>
    inet <span class="token number">192.168</span>.2.19/24 brd <span class="token number">192.168</span>.2.255 scope global eth0
</code></pre></div><p>当 <code>MASTER</code> 上的 <code>Nginx</code> 服务无法访问时， <code>VIP</code> 根据规则漂移到 <code>BACKUP</code> 上，接管 <code>MASTER</code> 。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># MASTER</span>
$ <span class="token function">ip</span> a <span class="token operator">|</span> <span class="token function">grep</span> eth0
<span class="token number">2</span>: eth0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UP qlen <span class="token number">1000</span>
    inet <span class="token number">192.168</span>.2.16/24 brd <span class="token number">192.168</span>.2.255 scope global eth0

<span class="token comment"># BACKUP</span>
$ <span class="token function">ip</span> a <span class="token operator">|</span> <span class="token function">grep</span> eth0
<span class="token number">2</span>: eth0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UP qlen <span class="token number">1000</span>
    inet <span class="token number">192.168</span>.2.19/24 brd <span class="token number">192.168</span>.2.255 scope global eth0
    inet <span class="token number">192.168</span>.2.200/32 scope global eth0
</code></pre></div><h2 id="参考链接"><a href="#参考链接" class="header-anchor">#</a> 参考链接</h2> <ul><li><a href="http://seanlook.com/2015/05/18/nginx-keepalived-ha/" target="_blank" rel="noopener noreferrer">Nginx+Keepalived实现站点高可用 | Sean's Notes<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://serverfault.com/questions/709428/track-script-doesnt-work-after-keepalived-update" target="_blank" rel="noopener noreferrer">centos7 - track script doesn't work after keepalived update - Server Fault<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Nginx/nginx_php_fpm.html" class="prev">
        使用PHP-FPM
      </a></span> <span class="next"><a href="/Nginx/configs.html">
        常用配置
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.6ea617b8.js" defer></script><script src="/assets/js/2.6e381248.js" defer></script><script src="/assets/js/54.70a6c075.js" defer></script>
  </body>
</html>
