(window.webpackJsonp=window.webpackJsonp||[]).push([[36],{237:function(a,s,t){"use strict";t.r(s);var e=t(6),r=Object(e.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"主从复制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#主从复制"}},[a._v("#")]),a._v(" 主从复制")]),a._v(" "),s("ul",[s("li",[a._v("系统环境：CentOS 7")]),a._v(" "),s("li",[a._v("软件版本：MySQL 5.6")]),a._v(" "),s("li",[a._v("Master：192.168.2.13")]),a._v(" "),s("li",[a._v("Slave：192.168.2.14")])]),a._v(" "),s("h2",{attrs:{id:"基于log-pos"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基于log-pos"}},[a._v("#")]),a._v(" 基于LOG POS")]),a._v(" "),s("h3",{attrs:{id:"master上的主要配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#master上的主要配置"}},[a._v("#")]),a._v(" Master上的主要配置")]),a._v(" "),s("div",{staticClass:"language-ini extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ini"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("log_bin")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("/home/mysql/u01/mysql/binlog/binlog")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("binlog_cache_size")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("32768")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("binlog_format")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("ROW")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("expire_logs_days")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("14")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("log_slave_updates")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("ON")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("sync_binlog")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("1")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("server-id")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("101")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("innodb_flush_log_at_trx_commit")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("1")]),a._v("\n")])])]),s("h3",{attrs:{id:"master上创建同步用户"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#master上创建同步用户"}},[a._v("#")]),a._v(" Master上创建同步用户")]),a._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("GRANT")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("REPLICATION")]),a._v(" SLAVE "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("ON")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("to")]),a._v(" rep_user"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("@'%'")]),a._v(" IDENTIFIED "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("BY")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'PASSWORD'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\nFLUSH PRIVIELEGS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])])]),s("h3",{attrs:{id:"mysqldump导出master数据库"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysqldump导出master数据库"}},[a._v("#")]),a._v(" mysqldump导出Master数据库")]),a._v(" "),s("p",[a._v("整库导出 "),s("code",[a._v("Master")]),a._v(" ，由于即有 "),s("code",[a._v("MyISAM")]),a._v(" 表也有 "),s("code",[a._v("InnoDB")]),a._v(" 表，因此在导出过程中需要全局锁表(--lock-all-tables)，记录 "),s("code",[a._v("LOG POS")]),a._v(" (--master-data=2)，并刷新二进制日志(--flush-logs)")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("mysqldump "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("root "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--password")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--triggers")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--events")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--routines")]),a._v(" --flush-logs --lock-all-tables --master-data"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v(" --all-databases "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" all_data.sql\n")])])]),s("p",[a._v("如果只需要同步某一个 "),s("code",[a._v("InnoDB")]),a._v(" 的库，且 "),s("code",[a._v("binlog_format = ROW")]),a._v(" ，那么可以使用 "),s("code",[a._v("binlog-do-db = db1")]),a._v(" 在 "),s("code",[a._v("Master")]),a._v(" 上指定只记录 "),s("code",[a._v("db1")]),a._v(" 的 "),s("code",[a._v("binlog")]),a._v(" ，同步时 "),s("code",[a._v("Slave")]),a._v(" 也只会读取到这些 "),s("code",[a._v("binlog")]),a._v(" 。在这种情况下，使用下面命令导出 "),s("code",[a._v("db1")]),a._v(" 数据库，在 "),s("code",[a._v("Slave")]),a._v(" 上导入时如果没有 "),s("code",[a._v("db1")]),a._v(" ，就手动创建一个")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("mysqldump "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("root "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--password")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--triggers")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--events")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--routines")]),a._v(" --flush-logs --single-transaction "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--opt")]),a._v(" --master-data"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--databases")]),a._v(" db1 "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" db1.sql\n")])])]),s("h3",{attrs:{id:"slave上的主要配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#slave上的主要配置"}},[a._v("#")]),a._v(" Slave上的主要配置")]),a._v(" "),s("p",[s("code",[a._v("binlog")]),a._v(" 相关设置与 "),s("code",[a._v("Master")]),a._v(" 基本一致，但是 "),s("code",[a._v("server-id")]),a._v(" 必须唯一，区别于 "),s("code",[a._v("Master")]),a._v(" ， "),s("code",[a._v("Slave")]),a._v(" 上除了基本的 "),s("code",[a._v("relay_log")]),a._v(" 相关配置之外， 还设置了一个 "),s("code",[a._v("skip-slave-start")]),a._v(" 选项，作用是 "),s("code",[a._v("MySQL")]),a._v(" 启动时不自动开启 "),s("code",[a._v("slave")]),a._v(" ，并将 "),s("code",[a._v("Slave")]),a._v(" 设置成只读模式，非 "),s("code",[a._v("super user")]),a._v(" 不能修改 "),s("code",[a._v("Slave")]),a._v(" 中的数据。")]),a._v(" "),s("div",{staticClass:"language-ini extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ini"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("log_bin")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("/home/mysql/u01/mysql-5.6.39/binlog/binlog")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("binlog_cache_size")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("32768")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("binlog_format")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("ROW")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("expire_logs_days")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("14")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("log_slave_updates")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("ON")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("sync_binlog")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("1")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("server-id")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("102")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("innodb_flush_log_at_trx_commit")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("1")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("relay_log")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("/home/mysql/u01/mysql-5.6.39/log/relaylog")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("relay_log_index")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("/home/mysql/u01/mysql-5.6.39/log/relay.index")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("relay_log_info_file")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("/home/mysql/u01/mysql-5.6.39/log/relay-log.info")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("slave_parallel_workers")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("4")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("slave_load_tmpdir")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("/home/mysql/u01/mysql-5.6.39/tmp")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("slave_skip_errors")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("OFF")]),a._v("\nskip-slave-start\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("read_only")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("ON")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("sync_master_info")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("1")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("sync_relay_log")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("1")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("sync_relay_log_info")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("1")]),a._v("\n")])])]),s("p",[s("code",[a._v("sync_master_info")]),a._v(" "),s("code",[a._v("sync_relay_log")]),a._v(" "),s("code",[a._v("sync_relay_log_info")]),a._v(" 三个选项可以最大限度的防止因  "),s("code",[a._v("Slave")]),a._v(" 服务器崩溃导致 "),s("code",[a._v("master_info")]),a._v(" 中继日志信息不完整，但是相应的会增加一些系统开销")]),a._v(" "),s("p",[s("code",[a._v("slave_parallel_workers")]),a._v(" 是多个线程复制选项，可以指定多个 "),s("code",[a._v("salve")]),a._v(" 工作线程，最大 "),s("code",[a._v("1024")]),a._v(" ，最小和默认是 "),s("code",[a._v("0")]),a._v(" ，该特性是 "),s("code",[a._v("MySQL 5.6.3")]),a._v(" 版本以后加入的")]),a._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[a._v("TIP")]),a._v(" "),s("p",[s("code",[a._v("slave_parallel_workers")]),a._v(" 选项在 "),s("code",[a._v("5.6")]),a._v(" 版本中只适用于多个 "),s("code",[a._v("schema")]),a._v(" 的场景，可以实现多个库并行复制，对于一库多表的场景，这个选项并不能发挥作用。但是在 "),s("code",[a._v("5.7")]),a._v(" 版本中引入了基于组提交的并行复制(Enhanced Multi-threaded Slaves)，可以通过设置 "),s("code",[a._v("slave_parallel_type＝'LOGICAL_CLOCK'")]),a._v(" 实现基于组提交的并行复制，详情参考："),s("a",{attrs:{href:"https://dev.mysql.com/doc/refman/5.7/en/replication-options-slave.html#sysvar_slave_parallel_type",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://dev.mysql.com/doc/refman/5.7/en/replication-options-slave.html#sysvar_slave_parallel_type"),s("OutboundLink")],1)])]),a._v(" "),s("p",[a._v("另外，可以根据实际情况设置几个可以忽略的同步错误代码，例如 "),s("code",[a._v("slave_skip_errors = 1032,1062,1007,1008")])]),a._v(" "),s("h3",{attrs:{id:"导入master上的数据库"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#导入master上的数据库"}},[a._v("#")]),a._v(" 导入Master上的数据库")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("mysql "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-uroot")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v(" all_data.sql\n")])])]),s("p",[a._v("如果是针对某一个库的同步，则只导入一个库的数据")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("mysql "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-uroot")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" db1 "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v(" db1.sql\n")])])]),s("p",[a._v("如果数据库比较大，可以使用 "),s("code",[a._v("screen")]),a._v(" 工具将数据导入任务放在后台运行。")]),a._v(" "),s("h3",{attrs:{id:"slave上开启同步"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#slave上开启同步"}},[a._v("#")]),a._v(" Slave上开启同步")]),a._v(" "),s("p",[a._v("在数据导入成功后，登录到 "),s("code",[a._v("Slave")]),a._v(" 上，清除所有二进制日志和中继日志，有必要时先备份这些日志")]),a._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[a._v("RESET MASTER"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\nRESET SLAVE "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("ALL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])])]),s("p",[s("code",[a._v("CHANGE MASTER")]),a._v(" 到前面 "),s("code",[a._v("all_data.sql")]),a._v(" 中记录的 "),s("code",[a._v("LOG POS")]),a._v(" 信息，然后启动 "),s("code",[a._v("salve")])]),a._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[a._v("CHANGE MASTER "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("TO")]),a._v(" MASTER_HOST"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'192.168.2.13'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("MASTER_LOG_FILE"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'mysql-bin.000020'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" MASTER_LOG_POS"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("107")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("START")]),a._v(" SLAVE "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("USER")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'rep_user'")]),a._v(" PASSWORD"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'PASSWORD'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])])]),s("p",[a._v("检查同步状态， "),s("code",[a._v("IO")]),a._v(" 和 "),s("code",[a._v("SQL")]),a._v(" 线程都是 "),s("code",[a._v("Yes")]),a._v(" ，表示同步已正常，多刷新几次观察日志同步的位置变化")]),a._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("SHOW")]),a._v(" SLAVE "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("STATUS")]),a._v("\\G\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1.")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("row")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("\n               Slave_IO_State: Waiting "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" master "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("to")]),a._v(" send event\n                  Master_Host: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v(".2")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v(".13")]),a._v("\n                  Master_User: rep_user\n                  Master_Port: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3306")]),a._v("\n                Connect_Retry: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("60")]),a._v("\n              Master_Log_File: binlog"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("000020")]),a._v("\n          Read_Master_Log_Pos: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("207856009")]),a._v("\n               Relay_Log_File: relaylog"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("000023")]),a._v("\n                Relay_Log_Pos: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("325850963")]),a._v("\n        Relay_Master_Log_File: binlog"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("000010")]),a._v("\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n            ···\n")])])]),s("h2",{attrs:{id:"基于gtid"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基于gtid"}},[a._v("#")]),a._v(" 基于GTID")]),a._v(" "),s("h3",{attrs:{id:"gtid简介"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gtid简介"}},[a._v("#")]),a._v(" GTID简介")]),a._v(" "),s("p",[s("code",[a._v("GTID(Global Transaction ID)")]),a._v(" 是对于一个已提交事务的编号，并且是一个全局唯一的编号。 "),s("code",[a._v("GTID")]),a._v(" 实际上是由 "),s("code",[a._v("UUID+TID")]),a._v(" 组成的。其中 "),s("code",[a._v("UUID")]),a._v(" 是一个 "),s("code",[a._v("MySQL")]),a._v(" 实例的唯一标识。 "),s("code",[a._v("TID")]),a._v(" 代表了该实例上已经提交的事务编号，并且随着事务提交单调递增。")]),a._v(" "),s("h3",{attrs:{id:"配置方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置方法"}},[a._v("#")]),a._v(" 配置方法")]),a._v(" "),s("p",[a._v("分别在 "),s("code",[a._v("Master")]),a._v(" 和 "),s("code",[a._v("Slave")]),a._v(" 上开启 "),s("code",[a._v("gitd")]),a._v(" 模式，在传统主从复制配置的基础上增加以下选项")]),a._v(" "),s("div",{staticClass:"language-ini extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ini"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("gtid_mode")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("ON")]),a._v("\nlog_slave_updates\nenforce_gtid_consistency\n")])])]),s("h3",{attrs:{id:"开启slave"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开启slave"}},[a._v("#")]),a._v(" 开启slave")]),a._v(" "),s("p",[a._v("启用 "),s("code",[a._v("gtid")]),a._v(" 后，在导出的 "),s("code",[a._v("SQL")]),a._v(" 文件中会包含以下语句，表示事务编号 "),s("code",[a._v("1-6127131")]),a._v(" 已经执行过，在导入 "),s("code",[a._v("Master")]),a._v(" 上导出的数据之后，同步将从事务 "),s("code",[a._v("ID 6127132")]),a._v(" 开始。")]),a._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("SET")]),a._v(" @"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("@GLOBAL.GTID_PURGED")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'ca9fd6a6-1a2e-11e8-8842-525400642e95:1-6127131'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])])]),s("p",[a._v("在 "),s("code",[a._v("Slave")]),a._v(" 上 "),s("code",[a._v("CHANGE MASTER")]),a._v(" ，然后开启 "),s("code",[a._v("slave")]),a._v(" ，在此之前先清除 "),s("code",[a._v("binlog")]),a._v(" 和 "),s("code",[a._v("relay-log")])]),a._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[a._v("RESET MASTER"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\nRESET SLAVE "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("ALL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\nCHANGE MASTER "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("TO")]),a._v(" MASTER_HOST"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'192.168.2.13'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" MASTER_PORT"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3006")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" MASTER_AUTO_POSITION"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("START")]),a._v(" SLAVE "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("USER")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'rep_user'")]),a._v(" PASSWORD"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'PASSWORD'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])])]),s("p",[a._v("当然也可以直接 "),s("code",[a._v("CHANGE MASTER")]),a._v(" ， "),s("code",[a._v("Slave")]),a._v(" 会自动从事务 "),s("code",[a._v("ID 1")]),a._v(" 开始同步，过程中可能会出现同步报错，例如表已存在的错误，可以视情况是否忽略。开启成功后，检查 "),s("code",[a._v("slave")]),a._v(" 状态是否正常。")])])}),[],!1,null,null,null);s.default=r.exports}}]);