(window.webpackJsonp=window.webpackJsonp||[]).push([[54],{255:function(a,e,s){"use strict";s.r(e);var t=s(6),n=Object(t.a)({},(function(){var a=this,e=a._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[e("h1",{attrs:{id:"keepalived-nginx"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#keepalived-nginx"}},[a._v("#")]),a._v(" Keepalived + Nginx")]),a._v(" "),e("h2",{attrs:{id:"拓扑"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#拓扑"}},[a._v("#")]),a._v(" 拓扑")]),a._v(" "),e("p",[e("code",[a._v("Nginx")]),a._v(" 作为负载均衡分发客户端请求到后端 "),e("code",[a._v("web")]),a._v(" 服务器， "),e("code",[a._v("Keepalived")]),a._v(" 为 "),e("code",[a._v("Nginx")]),a._v(" 提供高可用。")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("                           +-------------+\n                           |    Client   |\n                           +-------------+\n                                  |\n                                  +\n            MASTER            keepalived         BACKUP\n          192.168.2.16      192.168.2.200      192.168.2.19\n        +-------------+    +-------------+    +-------------+\n        |   nginx01   |----|  virtualIP  |----|   nginx02   |\n        +-------------+    +-------------+    +-------------+\n                                  |\n               +------------------+------------------+\n               |                  |                  |\n        +-------------+    +-------------+    +-------------+\n        |    web01    |    |    web02    |    |    web03    |\n        +-------------+    +-------------+    +-------------+\n")])])]),e("h2",{attrs:{id:"部署"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[a._v("#")]),a._v(" 部署")]),a._v(" "),e("h3",{attrs:{id:"安装keepalived"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装keepalived"}},[a._v("#")]),a._v(" 安装keepalived")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("yum "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-y")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" keepalived\n")])])]),e("h3",{attrs:{id:"配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[a._v("#")]),a._v(" 配置")]),a._v(" "),e("p",[e("code",[a._v("MASTER")]),a._v(" 节点的 "),e("code",[a._v("keepalived.conf")])]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('! Configuration File for keepalived\nglobal_defs {\n    notification_email {\n        admin@example.com\n    }\n    notification_email_from admin@example.com\n    smtp_server mail.example.com\n    smtp_connect_timeout 30\n    router_id LVS_DEVEL\n}\n\nvrrp_script chk_nginx {\n    script "/usr/libexec/keepalived/check_nginx.sh"\n    interval 5\n    weight -5\n    fall 2  \n    rise 1\n}\n\nvrrp_instance VI_1 {\n    state MASTER\n    interface eth0\n    mcast_src_ip 192.168.2.16\n    virtual_router_id 51\n    priority 101\n    advert_int 2\n    authentication {\n        auth_type PASS\n        auth_pass 1111\n    }\n    virtual_ipaddress {\n        192.168.2.200\n    }\n    track_script {\n       chk_nginx\n    }\n}\n')])])]),e("p",[e("code",[a._v("BACKUP")]),a._v(" 节点的 "),e("code",[a._v("keepalived.conf")]),a._v(" 与 "),e("code",[a._v("MASTER")]),a._v(" 一致，其中有几项不同")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 节点的初始状态")]),a._v("\nstate MASTER -"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" state BACKUP\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# BACKUP 节点的初始优先级小于 MASTER")]),a._v("\npriority "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("101")]),a._v(" -"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" priority "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("100")]),a._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 发送多播数据表的源 IP 地址")]),a._v("\nmcast_src_ip "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".2.16 -"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" mcast_src_ip "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".2.19\n")])])]),e("h3",{attrs:{id:"主要配置选项"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#主要配置选项"}},[a._v("#")]),a._v(" 主要配置选项")]),a._v(" "),e("p",[e("strong",[a._v("vrrp_instance")])]),a._v(" "),e("ul",[e("li",[a._v("state ： "),e("code",[a._v("VRRP")]),a._v(" 实例的初始状态， "),e("code",[a._v("MASTER")]),a._v(" 或 "),e("code",[a._v("BACKUP")])]),a._v(" "),e("li",[a._v("interface ： 指定实例绑定的网卡接口")]),a._v(" "),e("li",[a._v("mcast_src_ip ： 发送多播数据包时的源IP地址，可以使用 "),e("code",[a._v("interface")]),a._v(" 指定的网卡地址，但最好单独配置一块网卡专用于发送 "),e("code",[a._v("VRRP")]),a._v(" 通告")]),a._v(" "),e("li",[a._v("virtual_router_id ： "),e("code",[a._v("VRID")]),a._v(" ，相同的 "),e("code",[a._v("VRID")]),a._v(" 为一个组，决定了多播的 "),e("code",[a._v("MAC")]),a._v(" 地址")]),a._v(" "),e("li",[a._v("priority ： 本节点的优先级，优先级高的为 "),e("code",[a._v("MASTER")])]),a._v(" "),e("li",[a._v("advert_int ： "),e("code",[a._v("VRRP")]),a._v(" 通告发送时间间隔")]),a._v(" "),e("li",[a._v("authentication ： 定义认证方式和密码，主从保持一致")]),a._v(" "),e("li",[a._v("virtual_ipaddress ： "),e("code",[a._v("VIP")]),a._v(" ，随着 "),e("code",[a._v("state")]),a._v(" 的变化而增加删除，当 "),e("code",[a._v("state")]),a._v(" 为 "),e("code",[a._v("MASTER")]),a._v(" 的时候就添加，当 "),e("code",[a._v("state")]),a._v(" 为 "),e("code",[a._v("BACKUP")]),a._v(" 的时候删除， "),e("code",[a._v("state")]),a._v(" 主要由优先级来决定，可以设置多个 "),e("code",[a._v("IP")])]),a._v(" "),e("li",[a._v("track_script ： 引用 "),e("code",[a._v("VRRP")]),a._v(" 脚本，即在 "),e("code",[a._v("vrrp_script")]),a._v(" 块中指定的名字。定期运行它们来改变优先级，并最终引发主备切换。")])]),a._v(" "),e("p",[e("strong",[a._v("vrrp_script")])]),a._v(" "),e("ul",[e("li",[a._v("script ： 检测脚本，也可以是一行命令 "),e("code",[a._v("killall -0 nginx")]),a._v(" 。这里根据脚本执行的状态码来判断检测成功或者失败，为 "),e("code",[a._v("0")]),a._v(" 即成功，并且如果 "),e("code",[a._v("weight")]),a._v(" 大于 "),e("code",[a._v("0")]),a._v(" 则优先级增加；非 "),e("code",[a._v("0")]),a._v(" 即失败，并且如果 "),e("code",[a._v("weight")]),a._v(" 小于 "),e("code",[a._v("0")]),a._v(" ，则优先级减小。")]),a._v(" "),e("li",[a._v("interval 2 ： 每 "),e("code",[a._v("2s")]),a._v(" 检测一次")]),a._v(" "),e("li",[a._v("weight -5 ： 检测失败（脚本返回非0）则优先级 "),e("code",[a._v("-5")])]),a._v(" "),e("li",[a._v("fall 2 ： 检测连续 "),e("code",[a._v("2")]),a._v(" 次失败才算确定是真失败，失败后减少优先级")]),a._v(" "),e("li",[a._v("rise 1 ： 检测 "),e("code",[a._v("1")]),a._v(" 次成功就算成功，但不修改优先级")])]),a._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[a._v("TIP")]),a._v(" "),e("p",[a._v("可以设置多个检测脚本，即多个 "),e("code",[a._v("vrrp_script")]),a._v(" 块，从多方面监测 "),e("code",[a._v("Keepalived")]),a._v(" 节点。 "),e("code",[a._v("interval")]),a._v(" 设定的时间必须大于脚本运行的时间，如果脚本中有 "),e("code",[a._v("sleep")]),a._v(" 命令，需要适当调整 "),e("code",[a._v("interval")]),a._v(" 时间，否则可能会报错 "),e("code",[a._v("exited due to signal 15")])])]),a._v(" "),e("h2",{attrs:{id:"nginx服务检测脚本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#nginx服务检测脚本"}},[a._v("#")]),a._v(" Nginx服务检测脚本")]),a._v(" "),e("p",[e("code",[a._v("Keepalived")]),a._v(" 默认只能支持服务器级别的高可用，而不能实现应用级的高可用，但是可以通过 "),e("code",[a._v("track_script")]),a._v(" 选项来监测脚本的执行状态，然后由 "),e("code",[a._v("vrrp_script")]),a._v(" 中的选项对节点的优先级进行动态修改，以达到 "),e("code",[a._v("VIP")]),a._v(" 漂移的目的，变相实现对应用的高可用监测，编辑脚本 "),e("code",[a._v("/usr/libexec/keepalived/check_nginx.sh")])]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token shebang important"}},[a._v("#!/bin/bash")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("count")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("((")]),a._v(" i"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" i"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" i"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("++")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("))")])]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("do")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("check_code")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" --connect-timeout "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-sL")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-w")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"%{http_code}'),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[a._v("\\\\")]),a._v('n"')]),a._v(" http://localhost:8008 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-o")]),a._v(" /dev/null"),e("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$check_code")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!=")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"200"')]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n        "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("count")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n        "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("sleep")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("\n        "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("continue")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("else")]),a._v("\n        "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("count")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("\n        "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("break")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("done")]),a._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$count")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!=")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exit")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("else")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exit")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n")])])]),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("chmod")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("755")]),a._v(" /usr/libexec/keepalived/check_nginx.sh\nll "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-Z")]),a._v(" /usr/libexec/keepalived/check_nginx.sh\n-rwxr-xr-x. root root unconfined_u:object_r:keepalived_unconfined_script_exec_t:s0 /usr/libexec/keepalived/check_nginx.sh\n")])])]),e("p",[a._v("脚本连续访问主页 "),e("code",[a._v("2")]),a._v(" 次，如果没有返回 "),e("code",[a._v("http 200")]),a._v(" 状态，表示网站无法访问(不一定是 "),e("code",[a._v("Nginx")]),a._v(" 宕机)，如果检查失败，则返回状态码 "),e("code",[a._v("1")]),a._v(" ，相应的 "),e("code",[a._v("Keepalived")]),a._v(" 减少优先级，重新选举 "),e("code",[a._v("MASTER")]),a._v(" ，由新的 "),e("code",[a._v("MASTER")]),a._v(" 接管客户端请求。")]),a._v(" "),e("h2",{attrs:{id:"selinux"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#selinux"}},[a._v("#")]),a._v(" SELINUX")]),a._v(" "),e("p",[a._v("在开启了 "),e("code",[a._v("SELINUX")]),a._v(" 的情况下，检测脚本需要在 "),e("code",[a._v("/usr/libexec/keepalived/")]),a._v(" 目录下创建， "),e("code",[a._v("Keepalived")]),a._v(" 才能执行脚本")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" semanage fcontext "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-l")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("grep")]),a._v(" keepalived_unconfined_script_exec_t\n/usr/libexec/keepalived"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("/.*"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("?                      all files          system_u:object_r:keepalived_unconfined_script_exec_t:s0\n")])])]),e("p",[a._v("如果使用其他目录，需要配置安全上下文，当然也可以关闭 "),e("code",[a._v("SELINUX")])]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 临时生效")]),a._v("\n$ "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" chcon "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" keepalived_unconfined_script_exec_t /root/check_nginx.sh\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 永久生效")]),a._v("\n$ "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" semanage fcontext "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-a")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" pubic_content_t "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v("'/root/keepalived(/.*)?'")]),a._v("\n$ "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" restorecon "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-Rv")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v("'/root/keepalived/'")]),a._v("\n")])])]),e("h2",{attrs:{id:"防火墙"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#防火墙"}},[a._v("#")]),a._v(" 防火墙")]),a._v(" "),e("p",[a._v("节点之间要相互发送 "),e("code",[a._v("VRRP")]),a._v(" 通告，如果使用了 "),e("code",[a._v("iptables")]),a._v(" ，需要在添加放行 "),e("code",[a._v("VRRP")]),a._v(" 和 访问 多播地址 "),e("code",[a._v("224.0.0.18")]),a._v(" 的规则，否则可能产生裂脑问题，多个节点同时接管 "),e("code",[a._v("VIP")])]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("iptables "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-I")]),a._v(" INPUT "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("5")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".2.0/24 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("224.0")]),a._v(".0.18 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" ACCEPT\niptables "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-I")]),a._v(" INPUT "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("5")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".2.0/24 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" vrrp "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-j")]),a._v(" ACCEPT\niptables-save "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("/etc/sysconfig/iptables\n")])])]),e("h2",{attrs:{id:"vip漂移"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#vip漂移"}},[a._v("#")]),a._v(" VIP漂移")]),a._v(" "),e("p",[a._v("在 "),e("code",[a._v("Nginx")]),a._v(" 服务都正常的情况下， "),e("code",[a._v("VIP")]),a._v(" 位于优先级高的 "),e("code",[a._v("MASTER")]),a._v(" 上")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# MASTER")]),a._v("\n$ "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("ip")]),a._v(" a "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("grep")]),a._v(" eth0\n"),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v(": eth0: "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("BROADCAST,MULTICAST,UP,LOWER_UP"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" mtu "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("1500")]),a._v(" qdisc pfifo_fast state UP qlen "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("1000")]),a._v("\n    inet "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".2.16/24 brd "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".2.255 scope global eth0\n    inet "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".2.200/32 scope global eth0\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# BACKUP")]),a._v("\n$ "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("ip")]),a._v(" a "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("grep")]),a._v(" eth0\n"),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v(": eth0: "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("BROADCAST,MULTICAST,UP,LOWER_UP"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" mtu "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("1500")]),a._v(" qdisc pfifo_fast state UP qlen "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("1000")]),a._v("\n    inet "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".2.19/24 brd "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".2.255 scope global eth0\n")])])]),e("p",[a._v("当 "),e("code",[a._v("MASTER")]),a._v(" 上的 "),e("code",[a._v("Nginx")]),a._v(" 服务无法访问时， "),e("code",[a._v("VIP")]),a._v(" 根据规则漂移到 "),e("code",[a._v("BACKUP")]),a._v(" 上，接管 "),e("code",[a._v("MASTER")]),a._v(" 。")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# MASTER")]),a._v("\n$ "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("ip")]),a._v(" a "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("grep")]),a._v(" eth0\n"),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v(": eth0: "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("BROADCAST,MULTICAST,UP,LOWER_UP"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" mtu "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("1500")]),a._v(" qdisc pfifo_fast state UP qlen "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("1000")]),a._v("\n    inet "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".2.16/24 brd "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".2.255 scope global eth0\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# BACKUP")]),a._v("\n$ "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("ip")]),a._v(" a "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("grep")]),a._v(" eth0\n"),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v(": eth0: "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("BROADCAST,MULTICAST,UP,LOWER_UP"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" mtu "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("1500")]),a._v(" qdisc pfifo_fast state UP qlen "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("1000")]),a._v("\n    inet "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".2.19/24 brd "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".2.255 scope global eth0\n    inet "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".2.200/32 scope global eth0\n")])])]),e("h2",{attrs:{id:"参考链接"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考链接"}},[a._v("#")]),a._v(" 参考链接")]),a._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"http://seanlook.com/2015/05/18/nginx-keepalived-ha/",target:"_blank",rel:"noopener noreferrer"}},[a._v("Nginx+Keepalived实现站点高可用 | Sean's Notes"),e("OutboundLink")],1)]),a._v(" "),e("li",[e("a",{attrs:{href:"https://serverfault.com/questions/709428/track-script-doesnt-work-after-keepalived-update",target:"_blank",rel:"noopener noreferrer"}},[a._v("centos7 - track script doesn't work after keepalived update - Server Fault"),e("OutboundLink")],1)])])])}),[],!1,null,null,null);e.default=n.exports}}]);